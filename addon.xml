<?xml version="1.0" encoding="UTF-8"?>
<!--
SIMKL Scrobbler for Kodi
Version: 7.4.6
Last Modified: 2026-02-17

CHANGELOG:
7.4.6 - Fix rating dialog star highlighting
        - FIXED: Stars now properly highlight 1 through N as gold when rating is N
        - Changed star controls from button to radiobutton (supports setSelected)
        - Stars preview on hover/focus and persist on click
        - Hovering updates both star visuals and rating description
7.4.5 - Fix rerating setting not picked up from cached Addon object
        - FIXED: rating_allow_rerating read from stale cached Addon() singleton
        - Rating rerating check now uses fresh Addon() instance to see latest settings
7.4.4 - Standardize log messages across all modules
        - All 323 log calls now use consistent [module vX.X.X] Class.method() prefix
        - Removed 12 diagnostic logging lines (raw response dumps, sample entries)
        - Cleaned up api.py get_user_ratings() leftover diagnostic code
        - All 7 core modules updated: api, auth, exclusions, rating, scrobbler, service, sync
7.4.3 - Fix toast timing, rating dialog layout, existing rating lookup
        - FIXED: Toast delay increased to 5s before + 5s after (10s total)
        - FIXED: Rating dialog title/description off-screen (label positioning)
        - FIXED: Existing rating lookup now uses IMDb/TMDb IDs (not just SIMKL ID)
7.4.2 - Fix rating dialog stars invisible + toast hidden by rating dialog
        - FIXED: Star images were WEBP files with .png extensions (Kodi rejected them)
        - FIXED: "Marked as watched" toast covered by rating dialog opening immediately
        - Regenerated star images as proper PNG files
        - Added 3s delay after toast before opening rating dialog
7.4.1 - Fix toast notification timing, rating dialog, and sync thread auth
        - FIXED: "Marked as watched" toast swallowed by Kodi notification timing
        - FIXED: Rating dialog required SIMKL ID (now works with IMDb/TMDb/TVDB)
        - FIXED: Sync thread created API with empty token (fresh Addon() read)
        - FIXED: rating_min_view and rating_allow_rerating settings now wired up
        - FIXED: _build_rating_info() merges IDs from player + SIMKL data
7.4.0 - Addon ID renamed from script.simkl to script.simkl.scrobbler
        - Renamed addon ID to script.simkl.scrobbler (more descriptive)
        - Updated all Addon() calls, RunScript() commands, context menu dependencies
        - ZIP installs to script.simkl.scrobbler/ folder in Kodi addons
        - IMPORTANT: Remove old script.simkl/ folder manually before installing
        - Includes all fixes from 7.3.4 (uninstall locks, 401 auth, IMDb IDs, logging)
7.3.4 - FIX: Uninstall fails + scrobbling 401s + version tracking
        - FIXED: Sync thread file locks prevented addon directory removal on uninstall
        - FIXED: Service shutdown waits for sync thread cleanup before exiting
        - FIXED: API auto-retries on 401 with fresh Addon() settings read
        - FIXED: Settings change triggers API token refresh for post-auth pickup
        - FIXED: IMDb ID validation (tt prefix, TMDb numeric detection)
        - FIXED: Scrobble stop checks API response before claiming watched
        - ALL module versions bumped to 7.3.4 with verbose tagged logging
7.3.3 - FIX: Scrobbling 401 errors and IMDb ID format
        - FIXED: API auto-retries on 401 by refreshing token from settings (handles post-auth timing)
        - FIXED: IMDb IDs now validated with tt prefix (Kodi TMDb scraper returns raw numbers)
        - FIXED: getIMDBNumber() pure numeric values correctly identified as TMDb IDs
        - FIXED: Scrobble stop no longer claims success when API returned error
        - FIXED: Falls back to /sync/history when /scrobble/stop fails
7.3.2 - HOTFIX: Username not retrieved after authentication
        - FIXED: fetch_username() couldn't read token from settings due to Kodi async write timing
        - FIXED: Token now passed in-memory to fetch_username() instead of re-reading settings
        - FIXED: Username and success status returned directly from dialog to default.py
        - FIXED: auth_status now set from dialog return values, not stale settings re-read
        - Dialog shows "Authenticated as <username>!" on success
7.3.1 - HOTFIX: Auth dialog closing immediately
        - FIXED: NameError crash (max_attempts referenced outside thread scope)
        - FIXED: Dialog now stays open up to 15 minutes for PIN/QR auth
        - FIXED: Separated API error handler from polling to prevent cascade close
        - IMPROVED: Cancel responds within 500ms instead of waiting full poll interval
        - IMPROVED: Time remaining shows minutes:seconds format
7.3.0 - BUG FIXES: Authentication & Settings
        - FIXED: QR code now generated via API (removed broken pyqrcode dependency)
        - FIXED: PIN authentication polling with improved response handling
        - FIXED: Missing rating settings (Rate TV Shows, Minimum View Time, Re-rating)
        - REMOVED: script.module.pyqrcode dependency (never existed in Kodi repo)
        - Added detailed auth response logging for diagnostics
7.2.0 - PHASE 9: Advanced Features & Polish
        - ACTIVATED: All exclusion settings now functional
        - NEW: Exclude Live TV (pvr://) sources
        - NEW: Exclude HTTP/HTTPS streaming sources
        - NEW: Exclude plugin sources (plugin://)
        - NEW: Exclude script-controlled playback
        - NEW: Up to 5 custom path exclusions with cascading UI
        - RESTORED: Notifications category in settings
        - Version consistency: All modules now at 7.2.0
        - Fixed auth.py bug (VERSION -> __version__)
7.0.0 - PHASE 8: Localization Framework
        - NEW: Centralized localization helper (strings.py)
        - NEW: Complete English localization framework
        - All user-facing strings now use getLocalizedString()
        - Framework ready for future language additions
        - No functional changes - pure localization
        - Notifications: Localized all runtime messages
        - Rating Dialog: Localized all UI strings
        - Service: Localized sync and auth notifications
6.13.0 - Previous release
-->
<addon id="script.simkl.scrobbler" 
       name="SIMKL Scrobbler" 
       version="7.4.6" 
       provider-name="Claude.ai with assistance from Michael Beck">
    
    <requires>
        <import addon="xbmc.python" version="3.0.0"/>
        <import addon="script.module.requests" version="2.31.0"/>
    </requires>
    
    <!-- Script extension: Opens settings when addon is clicked -->
    <extension point="xbmc.python.script" library="default.py">
        <provides>executable</provides>
    </extension>
    
    <!-- Service extension: Background monitoring and scrobbling -->
    <extension point="xbmc.service" library="service.py"/>
    
    <!-- Addon metadata -->
    <extension point="xbmc.addon.metadata">
        <summary lang="en_GB">Scrobble your Kodi library to SIMKL</summary>
        <description lang="en_GB">Automatically track what you watch on Kodi to your SIMKL account. Supports movies and TV shows with real-time scrobbling. Mark content as watched when you hit your threshold (default 70%).</description>
        <platform>all</platform>
        <license>GPL-3.0-or-later</license>
        <source>https://github.com/thegoddamnbeckster/SIMKLScrobbler</source>
        <assets>
            <icon>icon.png</icon>
            <fanart>fanart.jpg</fanart>
        </assets>
    </extension>
</addon>
